//=============================================================================
// ■ memory.h
//-----------------------------------------------------------------------------
//   Driver > Basic > i686 > memory
//=============================================================================

#ifndef INCLUDE_MEMORY_H_
#define INCLUDE_MEMORY_H_

#include "Drivers/Basic/i686/types.h"
#include "multiboot.h"

#define SL_RW_P 3 // attributes: supervisor level, read/write, present.

class Memory {
	private:
	//---------------------------------------------------------------------------
	// ● 页表&页目录
	//---------------------------------------------------------------------------
	uint32_t volatile page_directory[1024] __attribute__((aligned(4096)));
	uint32_t volatile kern_page_table[1024] __attribute__((aligned(4096)));
	uint32_t mem_size, upper_mem;
	bool volatile *phy_c;

	public:
	//---------------------------------------------------------------------------
	// ● 占有物理内存(页计数)
	//---------------------------------------------------------------------------
	void AllocPhy(uint32_t f, uint32_t t);
	//---------------------------------------------------------------------------
	// ● 释放物理内存(页计数)
	//---------------------------------------------------------------------------
	void ReleasePhy(uint32_t f, uint32_t t);
	//---------------------------------------------------------------------------
	// ● 将页表绑定入页目录
	//---------------------------------------------------------------------------
	void map_pages_to_dir(int page_id, uint32_t* page_tab, uint8_t flag);
	//---------------------------------------------------------------------------
	// ● 将内存绑定入页表 (KByte计数)
	//---------------------------------------------------------------------------
	void map_physical_to_page_tab(uint32_t* page_tab, uint8_t flag, uint32_t f, uint32_t t);
	//---------------------------------------------------------------------------
	// ● 内存初始化
	//---------------------------------------------------------------------------
	Memory();
};

#endif
